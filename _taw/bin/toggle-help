#!/bin/bash

# Toggle help popup window
# If help is open, close it. If closed, open it.
# Uses tmux user option for reliable state tracking (same pattern as popup-shell)

set -e

SESSION_NAME="${1:-}"
if [ -z "$SESSION_NAME" ]; then
    echo "Usage: toggle-help SESSION_NAME" >&2
    exit 1
fi

# Resolve TAW_HOME if not set
if [ -z "$TAW_HOME" ]; then
    SCRIPT_PATH="$(cd "$(dirname "$0")" && pwd)"
    TAW_HOME="$(cd "$SCRIPT_PATH/../.." && pwd)"
fi

# tmux helper
tm() {
    tmux -L "taw-$SESSION_NAME" "$@"
}

# Check if help popup is currently open (using tmux user option)
HELP_OPEN=$(tm show-options -gqv @taw_help_open 2>/dev/null || echo "")

if [ "$HELP_OPEN" = "1" ]; then
    # Help is currently shown - close it
    # Note: display-popup -C only works from inside the popup
    # Opening a new popup that immediately exits will close the existing one
    tm set-option -g @taw_help_open ""
    tm display-popup -E "true" 2>/dev/null || true
else
    # Help is not shown - open it
    tm set-option -g @taw_help_open "1"

    # Create lesskey configuration inside the popup command
    # This binds Alt+H (\eh) and Alt+/ (\e/) to quit, allowing toggle with same key
    # Uses LESSKEYIN (for less 5.6+) to pass the source file directly
    # The lesskey file is created, used, and cleaned up all within the popup shell
    tm display-popup -E -w 80% -h 80% -T " Help (âŒ¥h or q to close) " \
        "KEYFILE=\$(mktemp) && printf '#command\n\\\\eh quit\n\\\\e/ quit\n' > \"\$KEYFILE\" && LESSKEYIN=\"\$KEYFILE\" less '$TAW_HOME/_taw/HELP.md'; tmux -L 'taw-$SESSION_NAME' set-option -g @taw_help_open '' 2>/dev/null || true; rm -f \"\$KEYFILE\""
fi
